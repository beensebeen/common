public with sharing class QuoteSummaryEmailSender_KH {

    public class EmailRequest {
        @InvocableVariable(required=true)
        public Id quoteId;
    }

    public class EmailResult {
        @InvocableVariable
        public String status;
    }

    @InvocableMethod(label='ì»¤ëª¬í•™ìŠµ êµ¬ë… ìš”ì•½ ë©”ì¼ ì „ì†¡')
    public static List<EmailResult> sendSummary(List<EmailRequest> requests) {
        List<EmailResult> results = new List<EmailResult>();

        for (EmailRequest req : requests) {
            EmailResult res = new EmailResult();

            try {
                // 1. Quote ì •ë³´ ì¡°íšŒ
                Quote q = [
                    SELECT Id, Name, Email, ContractId,
                           AccountName__c, AccountAddress__c, Phone,
                           ChildName__c, ChildBirth__c,
                           OriginalTotal__c, DiscountRate__c, TotalPrice__c
                    FROM Quote
                    WHERE Id = :req.quoteId
                    LIMIT 1
                ];

                // 2. ì—°ê²°ëœ Subscription__c ì¡°íšŒ
                List<Subscription__c> subs = [
                    SELECT ProductId__r.Name, StartDate__c, EndDate__c
                    FROM Subscription__c
                    WHERE ContractId__c = :q.ContractId
                    ORDER BY StartDate__c ASC
                ];

                // 3. ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
                if (String.isBlank(q.Email)) {
                    res.status = 'ì‹¤íŒ¨: ì´ë©”ì¼ ì—†ìŒ (Quote Id: ' + q.Id + ')';
                    results.add(res);
                    continue;
                }

                // 4. ê³¼ì • ìš”ì•½ HTML ì¡°ë¦½
                String courseDetails = '';
                Integer idx = 1;

                if (!subs.isEmpty()) {
                    for (Subscription__c sub : subs) {
                        String courseName = sub.ProductId__r != null ? sub.ProductId__r.Name : 'ê³¼ì •ëª… ì—†ìŒ';
                        String startStr = sub.StartDate__c != null ? String.valueOf(sub.StartDate__c) : 'ë¯¸ì •';
                        String endStr = sub.EndDate__c != null ? String.valueOf(sub.EndDate__c) : 'ë¯¸ì •';

                        courseDetails += idx + '. ' + courseName + '<br/>'
                                       + '&nbsp;&nbsp;- ê¸°ê°„: ' + startStr + ' ~ ' + endStr + '<br/><br/>';
                        idx++;
                    }
                } else {
                    courseDetails = '(ì‹ ì²­ëœ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤)<br/><br/>';
                }

                // 5. Static Resource ë¡œê³  ì´ë¯¸ì§€ URL ìƒì„±
                String logoUrl = System.Url.getOrgDomainUrl().toExternalForm() + '/resource/ComeonLogo';


                // 6. HTML ì´ë©”ì¼ ë³¸ë¬¸ ì¡°ë¦½
                String htmlBody = ''
                    + '<html><body>'
                    + '<img src="' + logoUrl + '" width="180" alt="ì»¤ëª¬í•™ìŠµ ë¡œê³ "/><br/><br/>'
                    + '<p>ì•ˆë…•í•˜ì„¸ìš”, ì»¤ëª¬í•™ìŠµì…ë‹ˆë‹¤.</p>'
                    + '<p><strong>' + q.AccountName__c + ' ê³ ê°ë‹˜</strong>,</p>'
                    + '<p>ì•„ë˜ëŠ” ì•„ì´ì˜ í•™ìŠµ êµ¬ë… ìš”ì•½ì…ë‹ˆë‹¤.</p>'
                    + '<hr/>'
                    + '<p>'
                    + 'ğŸ‘¦ ì•„ë™ ì´ë¦„ : ' + q.ChildName__c + '<br/>'
                    + 'ğŸ‚ ìƒë…„ì›”ì¼ : ' + String.valueOf(q.ChildBirth__c) + '<br/>'
                    + 'ğŸ“ ì—°ë½ì²˜ : ' + q.Phone + '<br/>'
                    + 'ğŸ  ì£¼ì†Œ : ' + q.AccountAddress__c + '<br/><br/>'
                    + 'ğŸ“˜ <strong>ì‹ ì²­ ê³¼ì •</strong><br/>' + courseDetails                 
                    + '<p>ğŸ’° <strong>ì •ê°€ ì´ì•¡</strong> : â‚©' + q.OriginalTotal__c.format() + '<br/>'
                    + 'ğŸ <strong>í• ì¸ìœ¨</strong> : ' + q.DiscountRate__c + '%<br/>'
                    + 'âœ… <strong>ìµœì¢… ê²°ì œ ê¸ˆì•¡</strong> : â‚©' + q.TotalPrice__c.format() + '</p>'
                    + '</p><br/>'
                    + '<p>ìš°ë¦¬ ì»¤ëª¬í•™ìŠµì˜ ê°€ì¡±ì´ ë˜ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br/>'
                    + 'ì•ìœ¼ë¡œë„ ì•„ì´ì˜ ì„±ì¥ì„ ìœ„í•´ í•¨ê»˜í•˜ê² ìŠµë‹ˆë‹¤.</p>'
                    + '<p><strong>ì»¤ëª¬í•™ìŠµ ë“œë¦¼</strong></p>'
                    + '</body></html>';

                // 7. ì´ë©”ì¼ ì „ì†¡
                Messaging.SingleEmailMessage mail = new Messaging.SingleEmailMessage();
                mail.setToAddresses(new String[] { q.Email });
                mail.setSubject('ì»¤ëª¬í•™ìŠµ êµ¬ë… ìš”ì•½ ì•ˆë‚´ - ' + q.Name);
                mail.setHtmlBody(htmlBody); // HTML í¬ë§·ìœ¼ë¡œ ì „ì†¡

                Messaging.sendEmail(new Messaging.SingleEmailMessage[] { mail });

                res.status = 'ì„±ê³µ: ' + q.Email + ' ë¡œ ë©”ì¼ ì „ì†¡ë¨';
            } catch (Exception e) {
                res.status = 'ì‹¤íŒ¨: ' + e.getMessage();
            }

            results.add(res);
        }

        return results;
    }
}